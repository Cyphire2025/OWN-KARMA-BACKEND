"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateUserPermissionsStep = exports.validateUserPermissionsStepId = void 0;
const utils_1 = require("@medusajs/framework/utils");
const workflows_sdk_1 = require("@medusajs/framework/workflows-sdk");
exports.validateUserPermissionsStepId = "validate-user-permissions";
/**
 * Validates that a user has access to all the policies they are trying to assign.
 * A user can only create roles and add policies that they themselves have access to.
 */
exports.validateUserPermissionsStep = (0, workflows_sdk_1.createStep)(exports.validateUserPermissionsStepId, async (data, { container }) => {
    const { actor_id, actor, policy_ids, actions } = data;
    if (!policy_ids?.length && !actions?.length) {
        return;
    }
    const query = container.resolve(utils_1.ContainerRegistrationKeys.QUERY);
    const { data: users } = await query.graph({
        entity: actor ?? "user",
        fields: ["rbac_roles.id", "rbac_roles.policies.*"],
        filters: { id: actor_id },
    });
    if (!users?.[0]?.rbac_roles || users[0].rbac_roles.length === 0) {
        throw new utils_1.MedusaError(utils_1.MedusaError.Types.UNAUTHORIZED, "Unauthorized");
    }
    const operationMap = new Map();
    users[0].rbac_roles.forEach((role) => {
        role.policies.forEach((policy) => {
            const op = policy.operation === "*" ? "*" : (0, utils_1.toSnakeCase)(policy.operation);
            operationMap.set(`${policy.resource}:${op}`, policy.id);
        });
    });
    const allUserPolicies = users[0].rbac_roles.flatMap((role) => role.policies || []);
    const userPolicyIds = new Set(allUserPolicies.map((p) => p.id));
    let unauthorizedPolicies = [];
    if (policy_ids?.length) {
        unauthorizedPolicies = policy_ids.filter((policyId) => !userPolicyIds.has(policyId));
    }
    else if (actions?.length) {
        unauthorizedPolicies = actions
            .filter((action) => {
            const op = action.operation === "*" ? "*" : (0, utils_1.toSnakeCase)(action.operation);
            return (!operationMap.has(`${action.resource}:${op}`) &&
                !operationMap.has(`${action.resource}:*`));
        })
            .map((action) => `${action.resource}:${action.operation}`);
    }
    if (unauthorizedPolicies.length) {
        throw new utils_1.MedusaError(utils_1.MedusaError.Types.UNAUTHORIZED, "Unauthorized");
    }
});
//# sourceMappingURL=validate-user-permissions.js.map